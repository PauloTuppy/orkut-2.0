name: CI/CD Orkut 2.0

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]

jobs:
  backend-lint-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: orkut_test
          POSTGRES_USER: orkut_user
          POSTGRES_PASSWORD: orkut_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      keydb:
        image: eqalpha/keydb:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "keydb-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
      
      - name: Lint with flake8
        run: |
          cd backend
          flake8 app --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 app --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: Format check with black
        run: |
          cd backend
          black --check app
      
      - name: Run backend tests
        env:
          DATABASE_URL: postgresql://orkut_user:orkut_password@localhost:5432/orkut_test
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET: test-secret-key
          ENVIRONMENT: test
        run: |
          cd backend
          pytest tests -v --tb=short

  frontend-lint-build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci --prefix frontend
      
      - name: Lint
        run: npm run lint --prefix frontend
      
      - name: Type check
        run: npm run type-check --prefix frontend
      
      - name: Build frontend
        run: npm run build --prefix frontend
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 7

  docker-build:
    runs-on: ubuntu-latest
    needs: [backend-lint-test, frontend-lint-build]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Build backend image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: false
          tags: orkut-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: false
          tags: orkut-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-staging:
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to staging
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          echo "Backend: orkut-backend:${{ github.sha }}"
          echo "Frontend: orkut-frontend:${{ github.sha }}"
          echo "TODO: Adicionar deploy para Railway, Render ou GCP Cloud Run"

  deploy-production:
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'release'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true
      
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker
      
      - name: Deploy to GCP Cloud Run
        run: |
          gcloud builds submit --config=cloudbuild.yaml \
            --substitutions=_CLOUDSQL_INSTANCE=${{ secrets.CLOUDSQL_INSTANCE }}
      
      - name: Get Service URLs
        id: get-urls
        run: |
          BACKEND_URL=$(gcloud run services describe orkut-backend --region=us-central1 --format='value(status.url)')
          FRONTEND_URL=$(gcloud run services describe orkut-frontend --region=us-central1 --format='value(status.url)')
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
      
      - name: Update Release Notes
        uses: actions/github-script@v6
        with:
          script: |
            const backendUrl = '${{ steps.get-urls.outputs.backend_url }}';
            const frontendUrl = '${{ steps.get-urls.outputs.frontend_url }}';
            
            github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: context.payload.release.body + `\n\n## ðŸš€ Deployed URLs\n- Frontend: ${frontendUrl}\n- Backend: ${backendUrl}\n- API Docs: ${backendUrl}/docs`
            });
